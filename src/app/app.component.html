<div class="flex flex-row h-full">

  <!-- Left Sidebar -->
  <div class="left sidebar min-h-full w-2 p-shadow-3 overflow-hidden z-3 p-1 flex flex-column h-full">
    <span class="p-input-icon-right w-full">
      <i class="pi pi-search"></i>
      <input type="text" class="w-full searchInput" placeholder="Search Articles" pInputText [(ngModel)]="leftSearch"
        (keyup)="onLeftSearchKeyUp(leftSearch, $event)" />
    </span>
    <div class="bigpseudo"></div>
    <!-- @TODO Add Button to toggle between Alphabetic Sorting Up Down, Last Changed Up Down, and Importance-->
    <app-hierarchical-list class="overflow-y-auto overflow-x-hidden"
      *ngIf="(this.articleHierarchyMap.size > 0 || this.lsArticleName) && this.project" [showBorderL]="true"
      [showNewArticleButton]="leftSearch !== undefined && leftSearch !== ''"
      [lsArticleName]="this.lsArticleName || 'New Article'" [lsParentName]="this.lsParentName"
      [currentWorkspace]="this.project.workspaces[this.project.activeWorkspaceIndex]"
      [listItems]="articleHierarchyArray" (articleClicked)="toggleArticleActive($event.name)"
      (articleActionClicked)="onListArticleActionClick($event)"
      (addArticleClicked)="addArticle(lsArticleName!, lsParentName); leftSearch = ''; lsArticleName = undefined; lsParentName = undefined"></app-hierarchical-list>
  </div>

  <!-- Center Area -->
  <div class="center flex flex-column min-h-full w-full relative overflow-hide">

    <!-- Menu Bar -->
    <p-menubar class="menubar" [model]="items">

      <!-- Workspaces -->
      <!-- @TODO Make Workspaces appear dynamically: When last empty workspace is used, add new one. Autoremove unselected empty workspaces except one-->
      <div *ngIf="project" class="flex flex-row toolbarWorkspaces">
        <div class="toolbarAddWorkspace pointerOnHover flex flex-column align-items-center justify-content-center" [tooltipPosition]="'bottom'" [pTooltip]="'Add New Workspace'"
          (click)="addView()">
          <div class="pi pi-plus"></div>
        </div>
        <div *ngFor="let workspace of project.workspaces; let index = index" [ngClass]="{'active': this.project.activeWorkspaceIndex === index}"
          class="hideChildUntilHoverParent toolbarWorkspace pointerOnHover" style="position: relative;"
          (click)="this.project.activeWorkspaceIndex = index" [tooltipPosition]="'bottom'" [pTooltip]="tooltipContent">
          <div class="flex flex-column workspace-articles">
            <div *ngFor="let workspace-article of workspace.activeArticles; index as i" class="workspace-article"></div>
          </div>
          <span [pTooltip]="'Close Workspace'" *ngIf="project.workspaces.length > 1"
            style="position: absolute; left: 20%; top:25px; scale: 70%"
            class="pi pi-trash element pointerOnHover hideChildUntilHoverChild toolbarWorkspaceDelete" (click)="removeView(index)">
          </span>
          <ng-template #tooltipContent>
            <div class="flex flex-column toolbarWorkspaceTooltip">
              <div *ngFor="let workspaceArticle of workspace.activeArticles; index as i"
                class="toolbarWorkspaceTooltipArticle">
                {{workspaceArticle}}
              </div>
              <div *ngIf="workspace.activeArticles.length === 0">
                Empty Workspace
              </div>
            </div>
          </ng-template>
        </div>
      </div>

    </p-menubar>

    <!-- Quick Navigation -->
    <div class="absolute flex flex-column z-2 footer" *ngIf="project" style="right: 0px; bottom: 0;">
      <div class="element pi pi-arrow-circle-up pointerOnHover" [pTooltip]="'Jump to top'"
        (click)="contentPanel.scrollTop = 0"></div>
      <div class="element pi pi-arrow-circle-down pointerOnHover" [pTooltip]="'Jump to bottom'"
        (click)="contentPanel.scrollTop = contentPanel.scrollHeight"></div>
    </div>

    <!-- Assistant Panel & Selector -->
    <div class="absolute left-0 bottom-0 flex flex-column align-items-start justify-content-start assistant-panel"
      *ngIf="project">
      <div class="flex flex-row align-items-end justify-content-start z-3 tabs" [ngClass]="{'active': activeAssistant}">
        <div class="flex flex-row">
          <div class="pi pi-comments pointerOnHover tab" [ngClass]="{'active': activeAssistant === 1}"
            [pTooltip]="activeAssistant === 1 ? 'Hide assistant panel' : 'Chat with LIQUID Assistant'"
            (click)="onToggleAssistant(1, chatInput)">
          </div>
          <input #chatInput type="text" class="w-full assistantInput" [ngClass]="{'active': activeAssistant === 1}"
            placeholder="Type, then press enter/return" pInputText />
        </div>
        <div class="flex flex-row">
          <div class="pi pi-plus-circle pointerOnHover tab" [pTooltip]="'Create new assistant or autonomous agent'">
          </div>
        </div>
      </div>
      <div class="panel-content overflow-y-auto" [ngClass]="{'active':activeAssistant}">
        <p class="m-0"></p>
      </div>
    </div>

    <!-- Internal Link Opener -->
    <input type="text" style="width: 0; height: 0; visibility: collapse" #internalLinkOpener id="internalLinkOpener"
      (click)="navigateInternalLink(internalLinkOpener.value, contentPanel)" />

    <!-- Article Page (Content) List -->
    <div class="content" style="
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        scroll-behavior: smooth;
      " styleClass="custombar" #contentPanel id="contentPanel">
      <div *ngFor="
          let activeArticleName of project && project.workspaces && project.workspaces.length > 0
            ? project.workspaces[project.activeWorkspaceIndex].activeArticles
            : [];
          let index = index
        " (mouseenter)="
          project!.workspaces[project!.activeWorkspaceIndex].highlightedPanelIndex = index
        ">
        <app-note-panel
          [isActivePanel]="project!.workspaces[project!.activeWorkspaceIndex].highlightedPanelIndex === index"
          [articles]="project!.articles" [articleName]="activeArticleName"
          (closePanelEvent)="toggleArticleActive(activeArticleName)" (moveUpEvent)="moveUp(index)"
          (moveDownEvent)="moveDown(index)"
          (internalLinkActivatedEvent)="this.toggleArticleActive($event)"></app-note-panel>
        <div class="pseudo"></div>
      </div>
      <div class="pseudo"></div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div class="right sidebar min-h-full w-2 p-shadow-3 p-1 flex flex-column h-full overflow-y-auto">
    <span class="p-input-icon-right w-full">
      <i class="pi pi-search"></i>
      <input type="text" class="w-full searchInput" placeholder="Search ${ArticeArticle}" [(ngModel)]="rightSearch"
        pInputText />
    </span>
  </div>

  <!-- Notification Outlet -->
  <p-toast position="bottom-center"></p-toast>

  <!-- Load Modal Dialog -->
  <p-dialog header="Load from indexedDB" appendTo="body" #loadDialog [(visible)]="loadDialogVisible">
    <p-table *ngIf="((allProjectsPromise | async)?.length ?? -1) > 0" [value]="
        (allProjectsPromise | async) ??
        [{ title: 'loading', lastModified: undefined }]
      " responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>Title</th>
          <th>Last Saved</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-project>
        <tr>
          <td>{{ project.title }}</td>
          <td>{{ project.lastModified }}</td>
          <td>
            <p-button label="Load" icon="pi pi-folder-open" styleClass="p-button-sm"
              (click)="loadFromDB(project.title)"></p-button>
          </td>
          <td>
            <p-button label="Delete" icon="pi pi-folder-open" styleClass="p-button-sm p-button-danger"
              (click)="deleteFromDB(project.title)"></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
    <div *ngIf="((allProjectsPromise | async)?.length ?? 0) === 0">
      No projects saved in indexedDB of Browser
    </div>
  </p-dialog>
  <p-confirmDialog #overlayOverlay [baseZIndex]="3000" width="425" appendTo="body"></p-confirmDialog>

  <!-- Settings Modal Dialog -->
  <p-dialog header="Settings & Preferences" appendTo="body" #settingsDialog [(visible)]="settingsDialogVisible">
    <!-- LLM Endpoints -->
    <div class="flex flex-column">
      <div class="flex flex-row justify-content-between">
        <input #LLM_Name type="text" class="settingsTextInput sm" [ngClass]="{'active': activeAssistant === 1}"
          placeholder="Name" pInputText />
        <input #LLM_Url type="text" class="settingsTextInput lg" [ngClass]="{'active': activeAssistant === 1}"
          placeholder="API Endpnt. URL" pInputText />
        <span>Blep</span>
      </div>
    </div>
  </p-dialog>

  <!-- Project Uploader Input -->
  <input style="visibility: collapse; width: 0; height: 0" type="file" class="file-input"
    (change)="onFileSelected(projectUpload)" #projectUpload />

  <!-- New Project Overlay -->
  <p-dialog header="Create new Project" [(visible)]="showNewProjectOverlay" #newProjectOverlay>
    <ng-template pTemplate>
      <div class="flex flex-wrap flex-column">
        <input autofocus type="text" placeholder="Project title (required)" pInputText style="margin-bottom: 5px"
          #newProjectTitleInput (keydown.enter)="newProjectButton.click()" [required]="true" />
        <button #newProjectButton [disabled]="!newProjectTitleInput.value" pButton pRipple type="button"
          icon="pi pi-plus" label="New Project" (click)="
            newProject(newProjectTitleInput.value);
            showNewProjectOverlay = false;
          " class="p-button-outlined"></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Save Project Overlay -->
  <p-dialog header="Save Project in IndexedDB of Browser" [(visible)]="showSaveProjectOverlay" #saveProjectOverlay>
    <ng-template pTemplate>
      <div class="flex flex-wrap flex-column" *ngIf="project">
        <input autofocus (keydown.enter)="saveProjectButton.click()" type="text" placeholder="Project title (required)"
          pInputText style="margin-bottom: 5px" #projectTitleInput [(ngModel)]="project.title" />
        <button #saveProjectButton [disabled]="!project.title" pButton pRipple type="button" icon="pi pi-save"
          label="Save to indexedDB" (click)="saveToDB(project.title); showSaveProjectOverlay = false;"
          class="p-button-outlined"></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Privacy Policy Modal Dialog-->
  <p-dialog header="Privacy Policy" #privacyPolicyDialog [(visible)]="showPrivacyPolicyDialog">
    <app-privacy-policy></app-privacy-policy>
  </p-dialog>
</div>