<div class="flex flex-row h-full">
  <!-- Left Sidebar -->
  <div class="left sidebar min-h-full w-2 p-shadow-3 overflow-hidden z-3 p-1 flex flex-column h-full">
    <!-- @TODO Add Button to toggle between Alphabetic Sorting Up Down, Last Changed Up Down, and Importance-->
    <app-hierarchical-list class="overflow-y-auto overflow-x-hidden articlesList" *ngIf="
        this.project
      " [project]="project" [hierarchyDirection]="'down'" [currentWorkspace]="
        this.project.workspaces[this.project.activeWorkspaceIndex]
      " [isListRoot]="true" [showSearch]="true" [hierarchyNodeList]="articleHierarchyMap | mapToList"
      (articleClickedEmitter)="toggleArticleActive($event.name)"
      (articleActionClicked)="onListArticleActionClick($event)"
      (addArticleEvent)="addArticle($event)"></app-hierarchical-list>
  </div>

  <!-- Center Area -->
  <div class="center flex flex-column min-h-full w-full relative overflow-hide">
    <!-- Dropdown Bar -->
    <div class="central-header flex flex-column">
      <div class="dropdown-panel overflow-y-auto flex flex-row" [ngClass]="{ active: dropdownPanelActiveTab }">
        <div *ngIf="dropdownPanelActiveTab === 'console'" class="flex flex-row w-full justify-content-end">
          <div class="w-full h-full flex flex-row"
            *ngIf="conversations[activeConversation].messages.length > 0 && conversations[activeConversation].messages[activeMessage] !== undefined">
            <textarea #msgarea pInputTextarea class="dialog-prompt-textarea" [ngClass]="{
              'inactive': !(conversations[activeConversation].messages[activeMessage].active)
            }" [(ngModel)]="conversations[activeConversation].messages[activeMessage].content"
              (change)="onTouchConversations()"></textarea>
            <div class="flex flex-column justify-content-end message-list">
              <div class="message-preview hideChildUntilHoverParent" [ngClass]="{
                'active':activeMessage === idx, 
                'system': msg.role === 'system',
                'user': msg.role === 'user',
                'assistant': msg.role === 'assistant',
                'inactive': !msg.active
                }" (click)="activeMessage = idx; msgarea.focus()"
                *ngFor="let msg of conversations[activeConversation].messages ?? []; index as idx">{{msg.content}}
                <div class="dialog-prompt-actions hideChildUntilHoverChild">
                  <i class="pi dialog-prompt-action"
                    [pTooltip]="msg.active ? 'This message will be included in prompts' : 'This message will not be included in prompts'"
                    tooltipPosition="left" (click)="msg.active = !msg.active; $event.stopPropagation()" [ngClass]="{
                    'pi-stop': !msg.active,
                    'pi-check-square': msg.active,
                  }"></i>
                  <i class="pi dialog-prompt-action" [pTooltip]="'Role: ' + msg.role" tooltipPosition="left"
                    (click)="msg.role === 'assistant' ? msg.role = 'user' : (msg.role === 'user' ? msg.role = 'system' : msg.role = 'assistant'); $event.stopPropagation()"
                    [ngClass]="{
                    'pi-user': msg.role === 'user',
                    'pi-globe': msg.role === 'assistant',
                    'pi-wrench': msg.role === 'system',
                  }"></i>
                  <i class="pi pi-trash dialog-prompt-action" pTooltip="Remove this message from the conversation"
                    (click)="conversations[activeConversation].messages.splice(idx, 1); activeMessage = (idx === 0 ? idx : idx - 1); $event.stopPropagation()"
                    tooltipPosition="left"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="dialog-prompt-control-panel">
            <div class="conversations">
              <div class="conversation" [pTooltip]="''+i" [ngClass]="{'active': i === activeConversation}"
                *ngFor="let conversation of conversations; let i = index"
                (click)="activeConversation = i; activeMessage = 0">
                {{i}}
              </div>
            </div>
            <div>
              <div class="flex flex-column align-items-center justify-content-center action" [pTooltip]="llm_selector"
                tooltipPosition="left" [autoHide]="false"
                (wheel)="selectedLLMIndex = scrollIncrementDecrement(false, $event, selectedLLMIndex, 1, llmApiService.llmConfigs.length-1)">
                <div class="pi pi-globe"></div>
              </div>
              <ng-template #llm_selector>
                <div class="settings-tooltip-header flex justify-content-between align-items-center">LLM Endpoint<div
                    class="iconoir-mouse-scroll-wheel" style="font-size: larger; margin-left: 5px;"></div>
                </div>
                <div class="settings-tooltip-selector" [ngClass]="{'active': selectedLLMIndex === i}"
                  *ngFor="let option of llmApiService.llmConfigs; let i = index" (click)="selectedLLMIndex = i">
                  {{option.name}}
                </div>
              </ng-template>
              <div class="flex flex-column align-items-center justify-content-center action"
                [pTooltip]="llmSettingsTooltip" tooltipPosition="left" [autoHide]="false"
                (wheel)="conversations[activeConversation].max_tokens= scrollIncrementDecrement(true, $event, conversations[activeConversation].max_tokens, 128, 4096)"
                (click)="temp.nativeElement.focus(); $event.stopImmediatePropagation()">
                <div class="pi pi-cog"></div>
              </div>
              <div class="flex flex-column align-items-center justify-content-center action" tooltipPosition="left"
                [autoHide]="false" (click)="deleteMessages()"
                (contextmenu)="deleteMessages(true); $event.preventDefault()" [pTooltip]="deleteConversation"
                tooltipPosition="left">
                <div class="pi pi-eraser"></div>
                <ng-template #deleteConversation>
                  <div class="flex justify-content-between align-items-center tooltip-background border-warn clickable"
                    (click)="deleteMessages()" style="margin-bottom: 2px;">
                    Clear conversation <div class="iconoir-mouse-button-left" style="font-size: larger;">
                    </div>
                  </div>
                  <div
                    class="flex justify-content-between align-items-center tooltip-background border-danger clickable"
                    (click)="deleteMessages(true)">
                    Clear all messages (incl. system msgs) <div class="iconoir-mouse-button-right"
                      style="font-size: larger;"></div>
                  </div>
                </ng-template>
              </div>
              <div class="flex flex-column align-items-center justify-content-center action" pTooltip="Prompt LLM"
                tooltipPosition="left" (click)="promptConversation()">
                <div class="pi pi-step-forward-alt"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="dropdownPanelActiveTab === 'alerts'">
      </div>

      <div class="flex flex-row" *ngIf="dropdownPanelActiveTab === 'menu'">
        <app-llm-settings class="box"></app-llm-settings>
        <app-idb-settings [activeProject]="project?.title ?? ''" [allProjects]="allProjectsPromise | async"
          (projectEventEmitter)="handleProjectEvent($event)" class="box"></app-idb-settings>
      </div>

      <!-- Menubar -->
      <div class="flex flex-row align-content-center">

        <!-- Workspaces -->
        <div *ngIf="project" class="flex flex-row toolbarWorkspaces relative">
          <div *ngFor="
              let workspace of project.workspaces;
              let index = index;
              let isLast = last
            " [ngClass]="{
              active: this.project.activeWorkspaceIndex === index,
              isLast: isLast
            }" [autoHide]="false" tooltipPosition="bottom" [pTooltip]="tooltipContent"
            class="hideChildUntilHoverParent toolbarWorkspace pointerOnHover relative"
            (click)="this.project.activeWorkspaceIndex = index">
            <div class="flex flex-column workspace-articles">
              <div *ngFor="
                  let &quot;workspace-article&quot; of workspace.viewedArticles;
                  index as i
                " class="workspace-article"></div>
            </div>
            <ng-template #tooltipContent>
              <div class="flex flex-column toolbarWorkspaceTooltip">
                <div *ngFor="
                    let workspaceArticle of workspace.viewedArticles;
                    let isLast = last
                  ">
                  <div class="toolbarWorkspaceTooltipArticle">
                    {{ workspaceArticle }}
                  </div>
                  <div class="pseudo" *ngIf="!isLast"></div>
                </div>

                <div *ngIf="workspace.viewedArticles.length === 0">
                  Empty Workspace
                </div>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Chat Input & Dropdown-Tabs -->
        <div class="tabs flex-grow-1">
          <div class="tabs-group command-line" [ngClass]="{ active: consoleInputFocused}">
            <input #consoleinput type="text" class="input flex-grow-1" pInputText (focus)="consoleInputFocused = true"
              [pTooltip]="''" (blur)="consoleInputFocused = false" (keyup)="commandLineKeyUp($event, consoleinput)" />
            <div class="tab flex flex-column align-items-center justify-content-center"
              [ngClass]="{ active: dropdownPanelActiveTab === 'console' }" tooltipPosition="bottom"
              [pTooltip]="'LLM Interface'" (click)="onToggleConsole('console')" [autoHide]="false">
              <div class="pi pi-comments"></div>
            </div>
          </div>
          <div class="separator"></div>
          <div class="flex flex-row tabs-group">
            <div class="tab flex flex-column align-items-center justify-content-center"
              [ngClass]="{ active: dropdownPanelActiveTab === 'alerts' }" tooltipPosition="bottom" [pTooltip]="'Alerts'"
              (click)="onToggleConsole('alerts')">
              <div class="pi pi-exclamation-circle "></div>
            </div>
            <div class="tab flex flex-column align-items-center justify-content-center"
              [ngClass]="{ active: dropdownPanelActiveTab === 'menu' }" [pTooltip]="'Menu'"
              (click)="onToggleConsole('menu')">
              <div class="pi pi-bars "></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Article Page (Content) List -->
    <div class="content" style="
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        scroll-behavior: smooth;
      " [ngClass]="{
        empty:
          project &&
          project.workspaces[project.activeWorkspaceIndex].viewedArticles
            .length === 0
      }" #contentPanel id="contentPanel">
      <!-- Active Articles -->
      <div *ngFor="
          let activeArticleName of project &&
          project.workspaces &&
          project.workspaces.length > 0
            ? project.workspaces[project.activeWorkspaceIndex].viewedArticles
            : [];
          let index = index;
          let isLast = last
        " (mouseenter)="setActiveArticle(index)">
        <app-note-panel [isActivePanel]="
            project!.workspaces[project!.activeWorkspaceIndex]
              .activeArticleIndex === index
          " [articles]="project!.articles" [articleName]="activeArticleName"
          (closePanelEvent)="toggleArticleActive(activeArticleName)" (moveUpEvent)="moveUp(index)"
          (moveDownEvent)="moveDown(index)" (internalLinkActivatedEvent)="this.toggleArticleActive($event)"
          (renameEvent)="renameArticle(activeArticleName, $event)"></app-note-panel>
        <div class="pseudo" *ngIf="!isLast"></div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div class="right sidebar min-h-full w-2 p-shadow-3 p-1 flex flex-column h-full overflow-y-auto collapsed">
    <div class="flex flex-row justify-content-between align-content-center articleTitle" *ngIf="activeArticle">
      <div>{{ activeArticle }}</div>
      <div>Actions</div>
    </div>
    <div *ngIf="activeArticle" class="articleDescription">
      <span class="primary"
        pTooltip="The very first paragraph of the article. This is frequently 'read' by LIQUID, like for determining if this article is relevant for a given LLM prompt.">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Maecenas accumsan
        lacus vel facilisis volutpat est. Quis vel eros donec ac odio tempor.
      </span>
      <br />
      <span class="secondary">
        Nulla aliquet enim tortor at. Porta nibh venenatis cras sed felis. Non
        nisi est sit amet facilisis magna etiam tempor orci. Sed egestas egestas
        fringilla phasellus faucibus scelerisque.
      </span>
    </div>
    <div class="labeled-separator flex flex-row" *ngIf="
    project && activeArticle && (articleHierarchyMap | articleHierarchyMapGet:activeArticle)[0].parents.length > 0
  " pTooltip="List of all categories this article belongs to directly or by extension">
      <div class="line left"></div>
      <div class="label">Categories</div>
      <div class="line right"></div>
    </div>
    <app-hierarchical-list class="overflow-y-auto overflow-x-hidden articlesList" *ngIf="
    project && activeArticle && (articleHierarchyMap | articleHierarchyMapGet:activeArticle)[0].parents.length > 0
  " [project]="project" [hierarchyDirection]="'up'" [currentWorkspace]="
    this.project.workspaces[this.project.activeWorkspaceIndex]
  " [isListRoot]="true" [hierarchyNodeList]="(articleHierarchyMap | articleHierarchyMapGet:activeArticle)[0].parents"
      (articleClickedEmitter)="toggleArticleActive($event.name)"
      (articleActionClicked)="onListArticleActionClick($event)"></app-hierarchical-list>
    <div class="labeled-separator flex flex-row"
      pTooltip="Table listing important attributes/characteristics of the article">
      <div class="line left"></div>
      <div class="label">Attributes</div>
      <div class="line right"></div>
    </div>
    <div *ngIf="activeArticle" class="idea-placeholder"
      pTooltip="The table of attributes that contain basic information on this article">
      Article Attributes
    </div>
    <div class="labeled-separator flex flex-row" pTooltip="Hierarchy of article sections/headlines">
      <div class="line left"></div>
      <div class="label">Sections</div>
      <div class="line right"></div>
    </div>
    <div *ngIf="activeArticle" class="idea-placeholder" pTooltip="Article section hierarchy (by headlines)">
      Article Headlines/Sections
    </div>
    <div class="labeled-separator flex flex-row" pTooltip="All links to other articles occuring in this article">
      <div class="line left"></div>
      <div class="label">Links</div>
      <div class="line right"></div>
    </div>
    <div *ngIf="activeArticle" class="idea-placeholder" pTooltip="Other articles that are linked in this article">
      Links
    </div>
    <div class="labeled-separator flex flex-row" pTooltip="All other articles that link to this article">
      <div class="line left"></div>
      <div class="label">Backlinks</div>
      <div class="line right"></div>
    </div>
    <div *ngIf="activeArticle" class="idea-placeholder" pTooltip="All other articles that reference this article">
      Backlinks
    </div>
  </div>

  <!-- Notification Outlet -->
  <p-toast position="bottom-center"></p-toast>

  <!-- Load Modal Dialog -->
  <p-dialog header="Load from indexedDB" appendTo="body" #loadDialog [(visible)]="loadDialogVisible">

  </p-dialog>
  <p-confirmDialog #overlayOverlay [baseZIndex]="3000" width="425" appendTo="body"></p-confirmDialog>

  <!-- Project Uploader Input -->
  <input style="visibility: collapse; width: 0; height: 0" type="file" class="file-input"
    (change)="onFileSelected(projectUpload)" #projectUpload />

  <!-- Privacy Policy Modal Dialog-->
  <p-dialog header="Privacy Policy" #privacyPolicyDialog [(visible)]="showPrivacyPolicyDialog">
    <app-privacy-policy></app-privacy-policy>
  </p-dialog>
</div>

<ng-template #llmSettingsTooltip>
  <div class="flex flex-column">
    <div class="settings-tooltip-header flex justify-content-between align-items-center">Max Tokens<div
        class="iconoir-mouse-scroll-wheel" style="font-size: larger;"></div>
    </div>
    <input #max_tokens type="number" [min]="0" [max]="4096" [step]="128" pInputText
      [(ngModel)]="conversations[activeConversation].max_tokens" tooltipPosition="left"
      [pTooltip]="'The maximum number of text the LLM may generate.\n(4 tokens ≈ 3 words)'" />
    <div class="settings-tooltip-header flex justify-content-between align-items-center" style="margin-top: 3px;">
      Temperature <div class="iconoir-mouse-button-left" style="font-size: larger;"></div>
    </div>
    <input #temp type="number" [min]="0" [max]="1" [step]="0.1" pInputText
      [(ngModel)]="conversations[activeConversation].temperature" tooltipPosition="left"
      [pTooltip]="'A higher temperature setting makes the LLM more likely to select less probable tokens when generating text.\nA temperature of 0 makes the LLM always select the most probable option.'" />
    <div class="settings-tooltip-header flex justify-content-between align-items-center" style="margin-top: 3px;">Top P
      <div class="iconoir-mouse-button-right" style="font-size: larger;"></div>
    </div>
    <input #top_p type="number" [min]="0" [max]="1" [step]="0.1" pInputText
      [(ngModel)]="conversations[activeConversation].top_p" tooltipPosition="left"
      [pTooltip]="'A lower  \'Top P\' removes less probable tokens from the selection when generating text.\nA \'Top P\' of 1 makes the LLM consider 100% of options when selecting the next token'" />
  </div>
</ng-template>